---
import BaseHead from '../components/BaseHead.astro'
import Header from '../components/Header.astro'
import Footer from '../components/Footer.astro'
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead
      title="Home"
      description="The home page for danielslaugh.com"
    />
    <style>
      main {
        max-width: 100%;
        margin: 0;
        padding: 2rem 1rem 4rem;
        display: grid;
        gap: 1rem;
        width: 100%;
      }
      .hero {
        display: grid;
        gap: 0.5rem;
      }
      .hero p {
        color: var(--text);
      }
      .game-shell {
        background: hsl(0 0% 12%);
        border: 1px solid hsl(0 0% 20%);
        border-radius: 10px;
        box-shadow: var(--box-shadow);
        padding: 1rem;
      }
      canvas {
        width: 100%;
        max-width: 920px;
        background: linear-gradient(#78c0ff, #9cd5ff 60%, #5bb14f 60%, #4a9c3f);
        border-radius: 8px;
        border: 2px solid hsl(0 0% 25%);
        image-rendering: pixelated;
        display: block;
        margin: 0 auto;
      }
      .controls {
        color: var(--text-light);
        font-size: 0.95rem;
      }
      .controls kbd {
        background: hsl(0 0% 20%);
        border: 1px solid hsl(0 0% 35%);
        border-radius: 4px;
        padding: 0.2rem 0.4rem;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <Header />
    <main>
      <!-- <div class="hero">
        <h1>Hello!</h1>
        <p>Welcome to my website</p>
      </div> -->
      <div class="game-shell">
        <canvas
          id="game"
          width="920"
          height="520"
        ></canvas>
        <p class="controls">
          Controls: <kbd>←</kbd> / <kbd>→</kbd> to move, <kbd>Space</kbd> or <kbd>↑</kbd> to jump, <kbd>R</kbd> to reset.
        </p>
      </div>
    </main>
    <Footer />
    <script>
      const canvas = document.getElementById('game')
      const ctx = canvas.getContext('2d')

      const gravity = 0.55
      const friction = 0.8
      const moveAccel = 0.8
      const maxSpeed = 6
      const jumpPower = -11

      const playerStart = { x: 80, y: 360 }
      const player = {
        x: playerStart.x,
        y: playerStart.y,
        w: 32,
        h: 40,
        vx: 0,
        vy: 0,
        onGround: false,
      }
      const recipesDoor = {
        x: 520,
        y: 150,
        w: 25,
        h: 25,
      }
      let enteredDoor = false

      const platforms = [
        { x: 0, y: 480, w: 920, h: 40 }, // floor
        { x: 140, y: 400, w: 140, h: 20 },
        { x: 360, y: 340, w: 160, h: 20 },
        { x: 600, y: 280, w: 120, h: 20 },
        { x: 520, y: 180, w: 110, h: 20 },
      ]

      const keys = new Set()

      window.addEventListener('keydown', (e) => {
        if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'Space', 'KeyR'].includes(e.code)) {
          e.preventDefault()
        }
        keys.add(e.code)
      })

      window.addEventListener('keyup', (e) => {
        keys.delete(e.code)
      })

      function reset() {
        player.x = playerStart.x
        player.y = playerStart.y
        player.vx = 0
        player.vy = 0
      }

      function update() {
        // horizontal input
        if (keys.has('ArrowLeft')) {
          player.vx = Math.max(player.vx - moveAccel, -maxSpeed)
        } else if (keys.has('ArrowRight')) {
          player.vx = Math.min(player.vx + moveAccel, maxSpeed)
        } else if (player.onGround) {
          player.vx *= friction
          if (Math.abs(player.vx) < 0.1) player.vx = 0
        }

        // jump
        if ((keys.has('Space') || keys.has('ArrowUp')) && player.onGround) {
          player.vy = jumpPower
          player.onGround = false
        }

        if (keys.has('KeyR')) {
          reset()
        }

        const prevX = player.x
        const prevY = player.y

        // apply physics
        player.vy += gravity
        player.x += player.vx
        resolveHorizontal(prevX)
        player.y += player.vy
        resolveVertical(prevY)

        // Door collision -> navigate to recipes
        if (!enteredDoor && intersects(player, recipesDoor)) {
          enteredDoor = true
          window.location.href = '/recipes'
        }
      }

      function resolveHorizontal(prevX) {
        for (const p of platforms) {
          if (!intersects(player, p)) continue
          if (player.vx > 0) {
            player.x = p.x - player.w
          } else if (player.vx < 0) {
            player.x = p.x + p.w
          } else {
            // fallback if velocity is 0 but overlap happened
            const fromLeft = prevX + player.w <= p.x
            player.x = fromLeft ? p.x - player.w : p.x + p.w
          }
          player.vx = 0
        }
      }

      function resolveVertical(prevY) {
        player.onGround = false
        for (const p of platforms) {
          if (!intersects(player, p)) continue
          if (player.vy > 0) {
            player.y = p.y - player.h
            player.vy = 0
            player.onGround = true
          } else if (player.vy < 0) {
            player.y = p.y + p.h
            player.vy = 0
          } else {
            const fromTop = prevY + player.h <= p.y
            player.y = fromTop ? p.y - player.h : p.y + p.h
            if (fromTop) player.onGround = true
          }
        }
      }

      function intersects(a, b) {
        return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y + 0.001
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)

        // platforms
        ctx.fillStyle = '#4a9c3f'
        for (const p of platforms) {
          ctx.fillRect(p.x, p.y, p.w, p.h)
          ctx.fillStyle = '#3c8232'
          ctx.fillRect(p.x, p.y, p.w, 6)
          ctx.fillStyle = '#4a9c3f'
        }

        // Recipes doorway
        ctx.fillStyle = '#b38300'
        ctx.fillRect(recipesDoor.x - 2, recipesDoor.y - 2, recipesDoor.w + 4, recipesDoor.h + 4)
        ctx.fillStyle = '#fdd835'
        ctx.fillRect(recipesDoor.x, recipesDoor.y, recipesDoor.w, recipesDoor.h)
        ctx.fillStyle = '#000'
        ctx.font = '16px "Atkinson", sans-serif'
        ctx.textAlign = 'center'
        ctx.fillText('To Recipes', recipesDoor.x + recipesDoor.w / 2, recipesDoor.y - 6)

        // player
        ctx.fillStyle = '#ff5a36'
        ctx.fillRect(player.x, player.y, player.w, player.h)

        // simple shadow
        ctx.fillStyle = 'rgba(0,0,0,0.25)'
        ctx.fillRect(player.x + 4, player.y + player.h - 6, player.w - 8, 6)
      }

      function loop() {
        update()
        draw()
        requestAnimationFrame(loop)
      }

      reset()
      loop()
    </script>
  </body>
</html>
